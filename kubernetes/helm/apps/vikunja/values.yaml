app-template:
  defaultPodOptions:
    enableServiceLinks: false

  controllers:
    # PostgreSQL Database
    postgres:
      containers:
        postgres:
          image:
            repository: postgres
            tag: 18
          env:
            POSTGRES_USER: vikunja
            POSTGRES_PASSWORD: changeme
            POSTGRES_DB: vikunja
          probes:
            readiness:
              enabled: true
              custom: true
              spec:
                exec:
                  command:
                    - /bin/sh
                    - -c
                    - pg_isready -U vikunja -d vikunja
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 5
                failureThreshold: 5
            liveness:
              enabled: true
              custom: true
              spec:
                exec:
                  command:
                    - /bin/sh
                    - -c
                    - pg_isready -U vikunja -d vikunja
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 5
                failureThreshold: 5

    # Vikunja Application
    vikunja:
      containers:
        vikunja:
          image:
            repository: vikunja/vikunja
            tag: latest
          env:
            # Database Configuration
            VIKUNJA_DATABASE_TYPE: postgres
            VIKUNJA_DATABASE_HOST: vikunja-postgres
            VIKUNJA_DATABASE_PORT: "5432"
            VIKUNJA_DATABASE_USER: vikunja
            VIKUNJA_DATABASE_PASSWORD: changeme
            VIKUNJA_DATABASE_DATABASE: vikunja

            # Service Configuration
            VIKUNJA_SERVICE_PUBLICURL: https://vikunja.intropin.be
            VIKUNJA_SERVICE_JWTSECRET: random1234

            # Server Configuration
            VIKUNJA_SERVICE_HTTPPORT: "3456"

          probes:
            readiness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  path: /api/v1/info
                  port: 3456
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 5
                failureThreshold: 5
            liveness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  path: /api/v1/info
                  port: 3456
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 5
                failureThreshold: 5

  service:
    # PostgreSQL service
    postgres:
      controller: postgres
      ports:
        postgres:
          port: 5432
          targetPort: 5432

    # Vikunja application service
    vikunja:
      controller: vikunja
      annotations:
        tailscale.com/expose: "true"
        tailscale.com/hostname: "vikunja"
      ports:
        http:
          port: 80
          targetPort: 3456

  persistence:
    # PostgreSQL data persistence
    postgres-data:
      enabled: true
      type: persistentVolumeClaim
      accessMode: ReadWriteOnce
      size: 5Gi
      storageClass: local-path-ssd
      advancedMounts:
        postgres:
          postgres:
            - path: /var/lib/postgresql/data
      forceRename: vikunja-postgres-data

    # Vikunja file storage
    vikunja-files:
      enabled: true
      type: persistentVolumeClaim
      accessMode: ReadWriteOnce
      size: 5Gi
      storageClass: local-path-ssd
      advancedMounts:
        vikunja:
          vikunja:
            - path: /app/vikunja/files
      forceRename: vikunja-files
