app-template:
  defaultPodOptions:
    enableServiceLinks: false
  controllers:
    # PostgreSQL Database
    db:
      containers:
        db:
          image:
            repository: postgres
            tag: "16"
          env:
            POSTGRES_USER: sure_user
            POSTGRES_PASSWORD: sure_password
            POSTGRES_DB: sure_production
          probes:
            readiness:
              enabled: true
              custom: true
              spec:
                exec:
                  command:
                    - /bin/sh
                    - -c
                    - pg_isready -U sure_user -d sure_production
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 5
                failureThreshold: 5
            liveness:
              enabled: true
              custom: true
              spec:
                exec:
                  command:
                    - /bin/sh
                    - -c
                    - pg_isready -U sure_user -d sure_production
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 5
                failureThreshold: 5

    # Redis Cache
    redis:
      containers:
        redis:
          image:
            repository: redis
            tag: latest
          probes:
            readiness:
              enabled: true
              custom: true
              spec:
                exec:
                  command:
                    - redis-cli
                    - ping
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 5
                failureThreshold: 5
            liveness:
              enabled: true
              custom: true
              spec:
                exec:
                  command:
                    - redis-cli
                    - ping
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 5
                failureThreshold: 5

    # Rails Web Application
    web:
      containers:
        web:
          image:
            repository: ghcr.io/we-promise/sure
            tag: latest
          env:
            # Database Configuration
            POSTGRES_USER: sure_user
            POSTGRES_PASSWORD: sure_password
            POSTGRES_DB: sure_production
            DB_HOST: sure-db
            DB_PORT: "5432"

            # Redis Configuration
            REDIS_URL: redis://sure-redis:6379/1

            # Rails Configuration
            SECRET_KEY_BASE: a7523c3d0ae56415046ad8abae168d71074a79534a7062258f8d1d51ac2f76d3c3bc86d86b6b0b307df30d9a6a90a2066a3fa9e67c5e6f374dbd7dd4e0778e13
            SELF_HOSTED: "true"
            RAILS_FORCE_SSL: "false"
            RAILS_ASSUME_SSL: "false"

            # OpenAI Configuration (optional - comment out if not needed)
            # OPENAI_ACCESS_TOKEN: ${OPENAI_ACCESS_TOKEN}

          # probes:
          #   readiness:
          #     enabled: true
          #     custom: true
          #     spec:
          #       httpGet:
          #         path: /health
          #         port: 3000
          #       initialDelaySeconds: 30
          #       periodSeconds: 10
          #       timeoutSeconds: 5
          #       failureThreshold: 5
          #   liveness:
          #     enabled: true
          #     custom: true
          #     spec:
          #       httpGet:
          #         path: /health
          #         port: 3000
          #       initialDelaySeconds: 30
          #       periodSeconds: 10
          #       timeoutSeconds: 5
          #       failureThreshold: 5

    # Sidekiq Worker
    worker:
      containers:
        worker:
          image:
            repository: ghcr.io/we-promise/sure
            tag: latest
          command:
            - bundle
            - exec
            - sidekiq
          env:
            # Database Configuration
            POSTGRES_USER: sure_user
            POSTGRES_PASSWORD: sure_password
            POSTGRES_DB: sure_production
            DB_HOST: sure-db
            DB_PORT: "5432"

            # Redis Configuration
            REDIS_URL: redis://sure-redis:6379/1

            # Rails Configuration
            SECRET_KEY_BASE: a7523c3d0ae56415046ad8abae168d71074a79534a7062258f8d1d51ac2f76d3c3bc86d86b6b0b307df30d9a6a90a2066a3fa9e67c5e6f374dbd7dd4e0778e13
            SELF_HOSTED: "true"
            RAILS_FORCE_SSL: "false"
            RAILS_ASSUME_SSL: "false"

            # OpenAI Configuration (optional - comment out if not needed)
            # OPENAI_ACCESS_TOKEN: ${OPENAI_ACCESS_TOKEN}

  service:
    # PostgreSQL service (internal only)
    db:
      controller: db
      ports:
        postgres:
          port: 5432
          targetPort: 5432

    # Redis service (internal only)
    redis:
      controller: redis
      ports:
        redis:
          port: 6379
          targetPort: 6379

    # Web application service
    web:
      controller: web
      annotations:
        tailscale.com/expose: "true"
        tailscale.com/hostname: "sure"
      ports:
        http:
          port: 80
          targetPort: 3000

  persistence:
    # PostgreSQL data persistence
    postgres-data:
      enabled: true
      type: persistentVolumeClaim
      accessMode: ReadWriteOnce
      size: 5Gi
      storageClass: local-path-ssd
      advancedMounts:
        db:
          db:
            - path: /var/lib/postgresql/data
      forceRename: sure-postgres-data

    # Redis data persistence
    redis-data:
      enabled: true
      type: persistentVolumeClaim
      accessMode: ReadWriteOnce
      size: 1Gi
      storageClass: local-path-ssd
      advancedMounts:
        redis:
          redis:
            - path: /data
      forceRename: sure-redis-data

    # Rails storage persistence
    app-storage:
      enabled: true
      type: persistentVolumeClaim
      accessMode: ReadWriteOnce
      size: 5Gi
      storageClass: local-path-ssd
      advancedMounts:
        web:
          web:
            - path: /rails/storage
        worker:
          worker:
            - path: /rails/storage
      forceRename: sure-app-storage
